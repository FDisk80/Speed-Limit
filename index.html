<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Limit</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        .sign-container {
            width: 90vmin;
            height: 90vmin;
            max-width: 400px;
            max-height: 400px;
            position: relative;
        }

        .speed-sign {
            width: 100%;
            height: 100%;
            background-color: white;
            border-radius: 50%;
            border: 15px solid #d90429;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        #speed-limit {
            /* Font size reduced as requested */
            font-size: 28vmin;
            font-weight: 700;
            color: #000000;
            line-height: 1;
        }
        
        @media (min-width: 450px) {
            #speed-limit {
                font-size: 120px;
            }
        }
        
        /* Smaller font size for error messages */
        .error-text {
            font-size: 15vmin !important;
        }
        
        @media (min-width: 450px) {
           .error-text {
                font-size: 70px !important;
            }
        }


        .message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            max-width: 90%;
            box-sizing: border-box;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>

    <div class="sign-container">
        <div class="speed-sign">
            <span id="speed-limit">...</span>
        </div>
    </div>
    
    <div id="messageBox" class="message-box"></div>

    <script>
        const speedLimitElement = document.getElementById('speed-limit');
        const messageBox = document.getElementById('messageBox');
        let lastKnownSpeed = null;
        let isFetching = false;

        // --- Data for improving accuracy ---

        // 1. Prioritize more important roads over less important ones.
        const roadHierarchy = [
            'motorway', 'trunk', 'primary', 'secondary', 'tertiary',
            'unclassified', 'residential', 'service'
        ];

        // 2. Fallback to default speed limits (km/h) based on road type if no explicit speed is found.
        // These can be adjusted for any region.
        const defaultSpeedLimits = {
            'motorway': 120,
            'trunk': 110,
            'primary': 90,
            'secondary': 90,
            'tertiary': 80,
            'residential': 50,
            'living_street': 30,
            'service': 40,
            'unclassified': 80
        };


        // --- Function to show messages to the user ---
        function showMessage(message, duration = 4000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // --- Function to fetch speed limit, now more robust ---
        async function fetchSpeedLimit(lat, lon) {
            // New query fetches ANY road nearby, not just those with a speed limit tag.
            const query = `[out:json][timeout:10];
                way(around:25, ${lat}, ${lon})[highway];
                out tags;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (data.elements.length === 0) return null; // No roads found

                // Find the most important road from the results based on our hierarchy.
                let bestRoad = data.elements[0];
                if (data.elements.length > 1) {
                    bestRoad = data.elements.sort((a, b) => {
                        const aIndex = roadHierarchy.indexOf(a.tags.highway);
                        const bIndex = roadHierarchy.indexOf(b.tags.highway);
                        return aIndex - bIndex;
                    })[0];
                }

                // First, check for an explicit 'maxspeed' tag on the best road.
                if (bestRoad.tags.maxspeed && !isNaN(bestRoad.tags.maxspeed)) {
                    showMessage("Found explicit speed limit.", 2000);
                    return bestRoad.tags.maxspeed;
                }
                
                // If no explicit tag, use our fallback defaults.
                const roadType = bestRoad.tags.highway;
                if (defaultSpeedLimits[roadType]) {
                    showMessage(`Using default for '${roadType}' road.`, 3000);
                    return defaultSpeedLimits[roadType];
                }

                return null; // No explicit or default speed found.
            } catch (error) {
                console.error("Error fetching speed limit:", error);
                showMessage("Could not fetch speed limit data.");
                return null;
            }
        }

        // --- Function to update the display ---
        function updateDisplay(speed) {
            const speedStr = speed ? String(speed) : '--';
            speedLimitElement.classList.remove('error-text');
            if (speedStr !== lastKnownSpeed) {
                console.log(`Speed limit changed from ${lastKnownSpeed} to ${speedStr}`);
                speedLimitElement.textContent = speedStr;
                lastKnownSpeed = speedStr;
            }
        }
        
        // --- Main function to process a successful location fix ---
        async function processLocation(position) {
            isFetching = false; 
            const { latitude, longitude } = position.coords;
            console.log(`Successfully got position: ${latitude}, ${longitude}`);
            const speed = await fetchSpeedLimit(latitude, longitude);
            updateDisplay(speed);
        }

        // --- Fallback function to get location with lower accuracy ---
        function tryFallbackLocation() {
            console.log("Primary location method failed. Attempting fallback...");
            navigator.geolocation.getCurrentPosition(
                processLocation,
                (err) => locationError(err, true),
                { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
            );
        }

        // --- Geolocation error handler ---
        function locationError(error, isFallback = false) {
            console.error(`Geolocation error (isFallback: ${isFallback}). Details:`, JSON.stringify(error, Object.getOwnPropertyNames(error)));
            if (isFallback) {
                speedLimitElement.classList.add('error-text');
                speedLimitElement.textContent = "API ERR";
                showMessage("Location is completely unavailable.", 8000);
                isFetching = false;
                return;
            }
            if (error && typeof error.code !== 'undefined' && error.code === 1) { // PERMISSION_DENIED
                speedLimitElement.classList.add('error-text');
                speedLimitElement.textContent = "DENIED";
                showMessage("Location access denied. Check browser/system settings.", 6000);
                isFetching = false;
                return;
            }
            // For any other error on the first try, attempt the fallback.
            tryFallbackLocation();
        }
        
        // --- Start the app ---
        function startApp() {
            if (!('geolocation' in navigator)) {
                showMessage("Geolocation is not supported by your browser.", 5000);
                speedLimitElement.textContent = "N/A";
                return;
            }

            const getLocationAndUpdate = () => {
                if (isFetching) { return; }
                isFetching = true;
                console.log("Requesting current position (high accuracy)...");
                navigator.geolocation.getCurrentPosition(
                    processLocation,
                    locationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            };

            getLocationAndUpdate();
            setInterval(getLocationAndUpdate, 5000);
        }

        window.onload = startApp;
    </script>
</body>
</html>
