<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Real-Time Speed Limit</title>
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
        }

        /* Renamed to vertical animation */
        @keyframes full-bob-vertical {
            0% { transform: translateY(0); }
            25% { transform: translateY(calc(50vh - 50% - 15px)); }
            50% { transform: translateY(0); }
            75% { transform: translateY(calc(-50vh + 50% + 15px)); }
            100% { transform: translateY(0); }
        }
        
        /* Added horizontal animation for landscape mode */
        @keyframes full-bob-horizontal {
            0% { transform: translateX(0); }
            25% { transform: translateX(calc(50vw - 50% - 15px)); }
            50% { transform: translateX(0); }
            75% { transform: translateX(calc(-50vw + 50% + 15px)); }
            100% { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 255, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 45px rgba(100, 255, 100, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 255, 255, 0.3); }
        }

        .sign-container {
            width: 90vmin;
            height: 90vmin;
            max-width: 450px;
            max-height: 450px;
            position: absolute;
            /* Animation is now applied via class */
        }

        /* Classes to apply orientation-specific animations */
        .bob-vertical {
            animation: full-bob-vertical 600s ease-in-out infinite;
        }
        .bob-horizontal {
            animation: full-bob-horizontal 600s ease-in-out infinite;
        }

        .speed-sign {
            width: 100%;
            height: 100%;
            background-color: white;
            border-radius: 50%;
            border: 15px solid #d90429;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            text-align: center;
        }
        
        .sign-pulse .speed-sign {
            animation: pulse 0.5s ease-out;
        }

        #speed-limit {
            font-weight: 900;
            color: #000000;
            /* UPDATED: Removed padding to allow flexbox to handle centering perfectly */
            box-sizing: border-box;
        }
        
        /* UPDATED: Reduced font sizes to prevent them from touching the border */
        .font-size-large {
            font-size: 62vmin; /* for 1-2 digits */
            line-height: 1; 
        }
        
        .font-size-medium {
            font-size: 46vmin; /* for 3 digits */
            line-height: 1; 
        }
        
        @media (min-width: 450px) {
            #speed-limit {
                /* Removed padding-top */
            }
            /* UPDATED: Adjusted fixed sizes to match vmin reduction */
            .font-size-large {
                font-size: 255px;
            }
            .font-size-medium {
                font-size: 185px;
            }
        }
        
        .error-text {
            font-size: 25vmin !important;
        }
        
        @media (min-width: 450px) {
           .error-text {
                font-size: 110px !important;
            }
        }
    </style>
</head>
<body>

    <div class="sign-container">
        <div class="speed-sign">
            <span id="speed-limit">...</span>
        </div>
    </div>
    
    <script>
        const speedLimitElement = document.getElementById('speed-limit');
        const signContainerElement = document.querySelector('.sign-container');
        let lastKnownSpeed = null;
        let watchId = null;
        let wakeLock = null;

        const requestWakeLock = async () => {
          if ('wakeLock' in navigator) {
            try {
              wakeLock = await navigator.wakeLock.request('screen');
              wakeLock.addEventListener('release', () => console.log('Screen Wake Lock was released'));
              console.log('Screen Wake Lock is active');
            } catch (err) {
              console.error(`Wake Lock Error: ${err.name}, ${err.message}`);
            }
          }
        };

        const toggleFullScreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        };

        async function fetchSpeedLimit(lat, lon) {
            const overpassApiUrl = 'https://overpass-api.de/api/interpreter';
            const primaryQuery = `[out:json][timeout:10]; way(around:50, ${lat}, ${lon})[highway][maxspeed]; out tags;`;
            
            try {
                const response = await fetch(`${overpassApiUrl}?data=${encodeURIComponent(primaryQuery)}`);
                if (!response.ok) throw new Error(`Primary query failed: ${response.status}`);
                const data = await response.json();
                
                if (data.elements.length > 0 && data.elements[0].tags.maxspeed) {
                    return data.elements[0].tags.maxspeed;
                }

                const fallbackQuery = `[out:json][timeout:10]; way(around:50, ${lat}, ${lon})[highway]; out tags;`;
                const fallbackResponse = await fetch(`${overpassApiUrl}?data=${encodeURIComponent(fallbackQuery)}`);
                if (!fallbackResponse.ok) throw new Error(`Fallback query failed: ${fallbackResponse.status}`);
                const fallbackData = await fallbackResponse.json();

                if (fallbackData.elements.length > 0) {
                    const roadType = fallbackData.elements[0].tags.highway;
                    switch (roadType) {
                        case 'motorway': return '110';
                        case 'trunk': return '90';
                        case 'primary': return '80';
                        case 'secondary': return '70';
                        case 'tertiary': return '60';
                        case 'residential':
                        case 'unclassified':
                        case 'living_street':
                            return '50';
                        default: return null;
                    }
                }
                return null;
            } catch (error) {
                console.error("Error fetching speed limit:", error);
                return null;
            }
        }

        function updateDisplay(speed, isInitialCall = false) {
            speedLimitElement.classList.remove('error-text');
            
            if (isInitialCall || speed !== lastKnownSpeed) {
                signContainerElement.classList.add('sign-pulse');
                setTimeout(() => signContainerElement.classList.remove('sign-pulse'), 500);

                const speedText = speed || '--';
                speedLimitElement.textContent = speedText;
                lastKnownSpeed = speed;
                speedLimitElement.classList.remove('font-size-large', 'font-size-medium');
                
                if (speedText.toString().length >= 3) {
                    speedLimitElement.classList.add('font-size-medium');
                } else {
                    speedLimitElement.classList.add('font-size-large');
                }
            }
        }
        
        async function processLocation(position) {
            const { latitude, longitude } = position.coords;
            console.log(`Watcher reported new position: ${latitude}, ${longitude}`);
            const speed = await fetchSpeedLimit(latitude, longitude);
            updateDisplay(speed);
        }

        function locationError(error) {
            console.error(`Geolocation error: ${error.message} (Code: ${error.code})`);
            if (error.code === error.PERMISSION_DENIED) {
                stopWatcher(); 
                speedLimitElement.classList.add('error-text');
                speedLimitElement.textContent = "DENIED";
            }
        }

        function startWatcher() {
            if (!('geolocation' in navigator)) return; 
            if (watchId === null) { 
                console.log("Starting location watcher...");
                watchId = navigator.geolocation.watchPosition(
                    processLocation,
                    locationError,
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            }
        }

        function stopWatcher() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                console.log("Location watcher paused.");
            }
        }
        
        const handleOrientationChange = () => {
            const isPortrait = screen.orientation.type.startsWith('portrait');
            console.log(`Orientation changed. Is Portrait: ${isPortrait}`);

            if (isPortrait) {
                console.log('Applying vertical animation.');
                signContainerElement.classList.remove('bob-horizontal');
                signContainerElement.classList.add('bob-vertical');
            } else {
                console.log('Applying horizontal animation.');
                signContainerElement.classList.remove('bob-vertical');
                signContainerElement.classList.add('bob-horizontal');
            }
        };

        function handleVisibilityChange() {
            if (document.hidden) {
                stopWatcher();
            } else {
                startWatcher();
                requestWakeLock();
            }
        }
        
        function startApp() {
            if (!('geolocation' in navigator)) {
                speedLimitElement.textContent = "N/A";
                return;
            }
            
            updateDisplay(null, true);
            startWatcher();
            requestWakeLock();
            
            document.body.addEventListener('click', toggleFullScreen);
            
            handleOrientationChange();
            if (screen.orientation && screen.orientation.addEventListener) {
                screen.orientation.addEventListener('change', handleOrientationChange);
            } else {
                window.addEventListener('resize', handleOrientationChange);
            }


            setTimeout(() => {
                if (!document.fullscreenElement) {
                   console.log("Attempting to enter fullscreen automatically.");
                   toggleFullScreen();
                }
            }, 1000);

            document.addEventListener('visibilitychange', handleVisibilityChange, false);
        }

        window.onload = startApp;
    </script>
    <!-- Script to register the service worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
</body>
</html>
